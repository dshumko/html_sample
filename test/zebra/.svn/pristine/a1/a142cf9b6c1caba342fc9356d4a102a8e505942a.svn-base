/*
 * TEST CASE for HTML5 Video/Audio
 *
 * written by STB-Component Browser Part.
 *
 */

var VIDEO_CONTENT = "http://10.0.12.33/media/video_sample.mp4";
var AUDIO_CONTENT = "http://10.0.12.33/media/audio_sample.mp3";
var DUMMY_CONTENT = "http://10.0.12.33/media/dummy.mp4";

var player = document.createElement('video');
player.setAttribute('id', 'video');
player.setAttribute('controls', true);
player.setAttribute('width', 320);
player.setAttribute('height', 240);
player.setAttribute('preload', 'none');

window.addEventListener('load', function(){
    document.body.appendChild(player);
});


function __checkRange(val, min, max) {
	return ( val >= min && val <= max )  ? true : false;
}

module("Properties");
test("audioTracks", function() {
		try {
		ok(player["audioTracks"] !== undefined, "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});

test("autoplay", function() {
		try {
		ok(player["autoplay"] !== undefined, "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});

test("buffered", function() {
		try {
		ok(player["buffered"] !== undefined, "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});

test("controller", function() {
		try {
		ok(player["controller"] !== undefined, "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});

test("controls", function() {
		try {
		ok(player["controls"] !== undefined, "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});

test("crossOrigin", function() {
		try {
		ok(player["crossOrigin"] !== undefined, "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});

test("currentSrc", function() {
		try {
		ok(player["currentSrc"] !== undefined, "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});

test("currentTime", function() {
		try {
		ok(player["currentTime"] !== undefined, "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});

test("defaultMuted", function() {
		try {
		ok(player["defaultMuted"] !== undefined, "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});

test("defaultPlaybackRate", function() {
		try {
		ok(player["defaultPlaybackRate"] !== undefined, "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});

test("duration", function() {
		try {
		ok(player["duration"] !== undefined, "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});

test("ended", function() {
		try {
		ok(player["ended"] !== undefined, "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});

test("error", function() {
		try {
		ok(player["error"] !== undefined, "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});

test("loop", function() {
		try {
		ok(player["loop"] !== undefined, "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});

test("mediaGroup", function() {
		try {
		ok(player["mediaGroup"] !== undefined, "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});

test("muted", function() {
		try {
		ok(player["muted"] !== undefined, "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});

test("networkState", function() {
		try {
		ok(player["networkState"] !== undefined, "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});

test("paused", function() {
		try {
		ok(player["paused"] !== undefined, "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});

test("playbackRate", function() {
		try {
		ok(player["playbackRate"] !== undefined, "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});

test("played", function() {
		try {
		ok(player["played"] !== undefined, "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});

test("preload", function() {
		try {
		ok(player["preload"] !== undefined, "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});

test("readyState", function() {
		try {
		ok(player["readyState"] !== undefined, "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});

test("seekable", function() {
		try {
		ok(player["seekable"] !== undefined, "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});

test("seeking", function() {
		try {
		ok(player["seeking"] !== undefined, "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});

test("src", function() {
		try {
		ok(player["src"] !== undefined, "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});

test("textTracks", function() {
		try {
		ok(player["textTracks"] !== undefined, "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});

test("videoTracks", function() {
		try {
		ok(player["videoTracks"] !== undefined, "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});

test("volume", function() {
		try {
		ok(player["volume"] !== undefined, "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});



module("Functions");

test("addTextTrack", function() {
		try {
		ok(typeof player["addTextTrack"] == 'function', "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});


test("canPlayType", function() {
		try {
		ok(typeof player["canPlayType"] == 'function', "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});

test("load", function() {
		try {
		ok(typeof player["load"] == 'function', "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});

test("play", function() {
		try {
		ok(typeof player["play"] == 'function', "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});

test("pause", function() {
		try {
		ok(typeof player["pause"] == 'function', "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});



module("Event Properties(Intrinsic)");

test("onabort", function() {
		try {
		ok(typeof player["onabort"] == 'object', "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});

test("oncanplay", function() {
		try {
		ok(typeof player["oncanplay"] == 'object', "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});

test("oncanplaythrough", function() {
		try {
		ok(typeof player["oncanplaythrough"] == 'object', "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});

test("ondurationchange", function() {
		try {
		ok(typeof player["ondurationchange"] == 'object', "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});

test("onemptied", function() {
		try {
		ok(typeof player["onemptied"] == 'object', "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});

test("onended", function() {
		try {
		ok(typeof player["onended"] == 'object', "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});

test("onerror", function() {
		try {
		ok(typeof player["onerror"] == 'object', "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});

test("onloadeddata", function() {
		try {
		ok(typeof player["onloadeddata"] == 'object', "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});

test("onloadedmetadata", function() {
		try {
		ok(typeof player["onloadedmetadata"] == 'object', "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});

test("onloadstart", function() {
		try {
		ok(typeof player["onloadstart"] == 'object', "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});

test("onpause", function() {
		try {
		ok(typeof player["onpause"] == 'object', "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});

test("onplay", function() {
		try {
		ok(typeof player["onplay"] == 'object', "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});


test("onplaying", function() {
		try {
		ok(typeof player["onplaying"] == 'object', "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});


test("onprogress", function() {
		try {
		ok(typeof player["onprogress"] == 'object', "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});

test("onratechange", function() {
		try {
		ok(typeof player["onratechange"] == 'object', "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});


test("onseeked", function() {
		try {
		ok(typeof player["onseeked"] == 'object', "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});


test("onseeking", function() {
		try {
		ok(typeof player["onseeking"] == 'object', "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});


test("onstalled", function() {
		try {
		ok(typeof player["onstalled"] == 'object', "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});


test("onsuspend", function() {
		try {
		ok(typeof player["onsuspend"] == 'object', "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});


test("ontimeupdate", function() {
		try {
		ok(typeof player["ontimeupdate"] == 'object', "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});


test("onvolumechange", function() {
		try {
		ok(typeof player["onvolumechange"] == 'object', "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});


test("onwaiting", function() {
		try {
		ok(typeof player["onwaiting"] == 'object', "is Exists?");
		} catch(e) {
		ok(false, e);
		}
		});


/* PlayBack Test */
var tcPlay = function(player, content) {
    asyncTest("Play", function () {
            setTimeout(function () {
                var min = 5.0;
                var max = 12.0;

                QUnit.start();
                player.pause();
                console.log("end play");
                if (__checkRange(player.currentTime, min, max)) {
                    ok(true, "Playback success");
                } else {
                    ok(false, "Playback fail");
                }

            }, 10000);

            player.src = content;
            player.load();
            player.play();
            console.log("start play");
        }
    );
};

var tcPause = function(player, content) {
    asyncTest("Pause", function () {
            setTimeout(function () {
                QUnit.start();
                if (player.currentTime > 0 && player.paused) {
                    ok(true, "Pause success");
                } else {
                    ok(false, "Pause fail");
                }
            }, 5000);

            player.src = content;
            player.load();
            player.play();

            setTimeout(function () {
                player.pause();
            }, 3000);
        }
    );
};

var tcPlaybackRate = function(player, content, rate) {
    asyncTest("tcPlaybackRatex"+rate, function(){
        setTimeout( function() {
            player.pause();
            QUnit.start();
            if ( player.currentTime > 0 && player.playbackRate == rate ) {
                ok(true, "tcPlaybackRate success");
            } else {
                ok(false, "tcPlaybackRate fail");
            }
        }, 8000);

        player.src = content;
        player.load();
        player.play();
        if ( rate < 0.0 ) {
            setTimeout(function() {
                //player.currentTime = player.duration-10.0;
                player.playbackRate = rate;
            }, 4000);
        } else {
            player.playbackRate = rate;
        }
    });
};

var tcSeekHalf = function(player, content, rate) {
    asyncTest("SeekHalf", function() {
        setTimeout( function() {
            QUnit.start();
            var half = player.duration/2;
            var min = half - 10.0;
            var max = half + 10.0;

            player.pause();
            if ( player.currentTime > 0 && __checkRange(player.currentTime, min, max) ) {
                ok(true, "SeekHalf success");
            } else {
                ok(false, "SeekHalf fail");
            }
        }, 10000);

        player.src = content;
        player.load();
        player.play();

        setTimeout(function() {
            player.currentTime = player.duration/2;
        }, 3000);
    });
};


var tcSeekStress = function(player, content) {
    asyncTest("SeekStress", function() {
        setTimeout( function() {
            QUnit.start();
            var half = player.duration/2;
            var min = half - 10.0;
            var max = half + 10.0;

            player.pause();
            if ( player.currentTime > 0 && __checkRange(player.currentTime, min, max) ) {
                ok(true, "SeekStress success");
            } else {
                ok(false, "SeekStress fail");
            }
        }, 10000);
        player.src = content;
        player.load();
        player.play();

        setTimeout(function() {
            player.currentTime += 10;
            player.currentTime += 10;
            player.currentTime += 10;
            player.currentTime += 10;
            player.currentTime = player.duration/2;
        }, 3000);
    });
};

var tcAutoPlay = function(player, content) {
    asyncTest("autoPlay", function () {
        setTimeout(function () {
            QUnit.start();
            player.pause();
            if (player.currentTime > 0) {
                ok(true, "autoplay success");
            } else {
                ok(false, "autoplay fail");
            }
        }, 7000);
        player.autoplay = true;
        player.src = content;
        player.load();
    });
};

var tcVolumeControl = function(player, content) {
    asyncTest("VolumeControl", function() {
        var volume = 0.8;
        setTimeout( function() {
            QUnit.start();
            player.pause();
            if ( player.currentTime > 0 && player.volume == volume ) {
                ok(true, "volume control success");
            } else {
                ok(false, "volume control fail");
            }
        }, 10000);
        player.src = content;
        player.load();
        player.play();
        setTimeout(function() {
            player.currentTime = player.duration/2;
            player.volume = volume;
        }, 3000);
    });
};

var tcMute = function(player, content) {
    asyncTest("Mute", function() {
        setTimeout( function() {
            QUnit.start();
            player.pause();
            if ( player.currentTime > 0 && player.muted ) {
                player.muted = false;
                ok(true, "volume mute success");
            } else {
                player.muted = false;
                ok(false, "volume mute fail");
            }
        }, 7000);
        player.src = content;
        player.load();
        player.play();
        setTimeout(function() {
            player.currentTime = player.duration/2;
            console.log(player.muted);
            player.muted = true;
        }, 3000);
    });
};

var tcLoop = function(player, content) {
    asyncTest("Loop", function() {
        setTimeout( function() {
            QUnit.start();
            var min = 1.0;
            var max = 15.0;
            player.pause();
            player.loop = false;
            console.log("loop="+player.currentTime);
            if ( __checkRange(player.currentTime, min, max ) ) {
                ok(true, "loop success");
            } else {
                ok(false, "loop fail");
            }
        }, 15000);
        player.src = content;
        player.loop = true;
        player.load();
        player.play();
        setTimeout(function() {
            player.currentTime = player.duration - 2.0;
        }, 5000);
    });
};

var tcOnLoaded = function(player, content) {
    asyncTest("OnLoaded", function() {
        var loaded = false;
        setTimeout( function() {
            QUnit.start();
            if ( loaded ) {
                ok(true, "onloaded success");
            } else {
                ok(false, "onloaded fail");
            }
        }, 5000);
        player.src = content;
        player.onloadeddata = function() {
            loaded = true;
        }
        player.onloadedmetadata = function() {
            loaded = true;
        }
        player.addEventListener("loadeddata", function() {
                loaded = true;
            }
        );
        player.load();
    });
};

var tcOnCanPlay = function(player, content) {
    asyncTest("OnCanPlay", function() {
        var canplay = false;
        setTimeout( function() {
            QUnit.start();
            player.pause();
            if ( canplay ) {
                ok(true, "oncanplay success");
            } else {
                ok(false, "oncanplay fail");
            }
        }, 5000);
        player.src = content;
        player.oncanplay = function() {
        }
        player.addEventListener("canplay", function() {
                canplay = true;
            }
        );
        player.load();
        player.play();
    });
};

var tcOnEnded = function(player, content) {
    asyncTest("OnEnded", function() {
        var ended = false;
        setTimeout( function() {
            QUnit.start();
            if ( ended ) {
                ok(true, "onended success");
            } else {
                ok(false, "onended fail");
            }
        }, 10000);
        player.src = content;
        player.onended = function() {
            ended = true;
        }
        player.addEventListener("ended", function() {
                ended = true;
            }
        );
        player.load();
        player.play();
        setTimeout(function() {
            player.currentTime = player.duration - 2.0;
        }, 3000);
    });
};

var tcOnPlay = function(player, content) {
    asyncTest("OnPlay", function() {
        var played = false;
        setTimeout( function() {
            QUnit.start();
            player.pause();
            if ( played ) {
                ok(true, "onplay success");
            } else {
                ok(false, "onplay fail");
            }
        }, 5000);
        player.src = content;
        player.onplay = function() {
            played = true;
        }
        player.addEventListener("play", function() {
                played = true;
            }
        );
        player.load();
        player.play();
    });
};

var tcOnDurationChange = function(player, content) {
    asyncTest("OnDurationChange", function() {
        var dur_change = false;
        setTimeout( function() {
            QUnit.start();
            player.pause();
            if ( dur_change ) {
                ok(true, "ondurationchange success");
            } else {
                ok(false, "ondurationchange fail");
            }
        }, 5000);
        player.src = content;
        player.ondurationchange = function() {
            dur_change = true;
        }
        player.addEventListener("durationchange", function() {
                dur_change = true;
            }
        );
        player.load();
        player.play();
    });
};

var tcOnPause = function(player, content) {
    asyncTest("OnPause", function() {
        var paused = false;
        setTimeout( function() {
            QUnit.start();
            if ( paused ) {
                ok(true, "onpause success");
            } else {
                ok(false, "onpause fail");
            }
        }, 7000);
        player.src = content;
        player.onpause = function() {
            paused = true;
        }
        player.addEventListener("pause", function() {
                paused = true;
            }
        );
        player.load();
        player.play();
        setTimeout(function() {
            player.pause();
        }, 3000);
    });
};

var tcOnRateChange = function(player, content) {
    asyncTest("OnRateChange", function() {
        var rated = false;
        setTimeout( function() {
            player.pause();
            if ( player.currentTime > 0 && rated ) {
                ok(true, "onratechange success");
            } else {
                ok(false, "onratechange fail");
            }
            QUnit.start();
        }, 7000);
        player.src = content;
        player.onratechange = function() {
            rated = true;
        }
        player.addEventListener("ratechange", function() {
                rated = true;
            }
        );
        player.load();
        player.play();
        player.playbackRate = 2.0;
    });
};

var tcOnError = function(player, content) {
    asyncTest("OnError", function() {
        var error = false;
        setTimeout( function() {
            QUnit.start();
            player.pause();
            if ( error ) {
                ok(true, "onerror success");
            } else {
                ok(false, "onerror fail");
            }
        }, 3000);
        player.src = content;
        player.onerror = function() {
            error = true;
        }
        player.addEventListener("error", function() {
                error = true;
            }
        );
        player.load();
        player.play();
    });
};

function tcPlaybackVideo(player) {
	module("Playback - Video");
	tcPlay(player, VIDEO_CONTENT);
	tcPause(player, VIDEO_CONTENT);
	tcPlaybackRate(player, VIDEO_CONTENT, 2.0);
	tcPlaybackRate(player, VIDEO_CONTENT, 4.0);
	tcPlaybackRate(player, VIDEO_CONTENT, 8.0);

	tcSeekHalf(player, VIDEO_CONTENT);
	tcSeekStress(player, VIDEO_CONTENT);
	tcAutoPlay(player, VIDEO_CONTENT);
	tcVolumeControl(player, VIDEO_CONTENT);
	tcMute(player, VIDEO_CONTENT);
	tcLoop(player, VIDEO_CONTENT);
	module("Event - Video");
	tcOnLoaded(player, VIDEO_CONTENT);
	tcOnCanPlay(player, VIDEO_CONTENT);
	tcOnEnded(player, VIDEO_CONTENT);
	tcOnPlay(player, VIDEO_CONTENT);
	tcOnDurationChange(player, VIDEO_CONTENT);
	tcOnPause(player, VIDEO_CONTENT);
	tcOnRateChange(player, VIDEO_CONTENT);
	tcOnError(player, DUMMY_CONTENT);
}

function tcPlaybackAudio(player) {
	module("Playback - Audio");
	tcPlay(player, AUDIO_CONTENT);
	tcPause(player, AUDIO_CONTENT);
	tcPlaybackRate(player, AUDIO_CONTENT, 2.0);
	tcPlaybackRate(player, AUDIO_CONTENT, 4.0);
	tcPlaybackRate(player, AUDIO_CONTENT, 8.0);
	tcSeekHalf(player, AUDIO_CONTENT);
	tcSeekStress(player, AUDIO_CONTENT);
	tcAutoPlay(player, AUDIO_CONTENT);
	tcVolumeControl(player, AUDIO_CONTENT);
	tcMute(player, AUDIO_CONTENT);
	tcLoop(player, AUDIO_CONTENT);
	module("Event - Audio");
	tcOnLoaded(player, AUDIO_CONTENT);
	tcOnCanPlay(player, AUDIO_CONTENT);
	tcOnEnded(player, AUDIO_CONTENT);
	tcOnPlay(player, AUDIO_CONTENT);
	tcOnDurationChange(player, AUDIO_CONTENT);
	tcOnPause(player, AUDIO_CONTENT);
	tcOnRateChange(player, AUDIO_CONTENT);
	tcOnError(player, DUMMY_CONTENT);
}

tcPlaybackVideo(player);
tcPlaybackAudio(player);
